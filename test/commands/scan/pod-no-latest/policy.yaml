apiVersion: json.kyverno.io/v1alpha1
kind: ValidatingPolicy
metadata:
  name: test
spec:
  rules:
    - name: pod-no-latest
      context:
        - name: tag
          variable: :latest
      match:
        any:
        - apiVersion: v1
          kind: Pod
      identifier: "metadata.name"
      assert:
        all:
        - check:
            spec:
              (containers)->foos:
                ~foo.containers:
                  (at($foos, $foo).image)->foo:
                    # an image tag is required
                    (contains($foo, ':')): true
                    # using a mutable image tag e.g. 'latest' is not allowed
                    (ends_with($foo, $tag)): false
        - check:
            spec:
              (containers)->foo:
                ~.containers:
                  image:
                    # an image tag is required
                    (contains(@, ':')): true
                    # using a mutable image tag e.g. 'latest' is not allowed
                    (ends_with(@, ':latest')): false
        - check:
            (spec.containers[*].image)->images:
              ~index.(spec.containers[*].image):
                # an image tag is required
                (contains(@, ':')): true
                # using a mutable image tag e.g. 'latest' is not allowed
                (ends_with(@, ':latest')): false
