apiVersion: json.kyverno.io/v1alpha1
kind: Policy
metadata:
  name: test
spec:
  rules:
    - name: pod-no-latest
      context:
        - name: tag
          variable:
            value: :latest
      match:
        any:
        - resource:
            apiVersion: v1
            kind: Pod
      validate:
        assert:
          all:
          - resource:
              spec:
                ~foo.containers@foos:
                  (at($foos, $foo).image)@foo:
                    # an image tag is required
                    (contains($foo, ':')): true
                    # using a mutable image tag e.g. 'latest' is not allowed
                    (ends_with($foo, $tag)): false
          - resource:
              spec:
                ~.containers@foo:
                  image:
                    # an image tag is required
                    (contains(@, ':')): true
                    # using a mutable image tag e.g. 'latest' is not allowed
                    (ends_with(@, ':latest')): false
          - resource:
              ~index.(spec.containers[*].image)@images:
                # an image tag is required
                (contains(@, ':')): true
                # using a mutable image tag e.g. 'latest' is not allowed
                (ends_with(@, ':latest')): false
